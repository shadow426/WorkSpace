定时器就是计数器

![[Pasted image 20250404150433.png]]![[Pasted image 20250404150530.png]]


预分频器：因为是从0开始计数，n分频对应的数值为n-1
![[Pasted image 20250404150924.png]]

如果想长时间高精度定时，可以尝试卫星授时校准方案

自动重装载寄存器，检测计数器的值是否与自己相等，如果相等则让计数器清零并触发定时器更新中断
![[Pasted image 20250404151434.png]]

勾选或选中internal Clock即可打开定时器




放在while(1)之前，计数器开始工作
HAL_TIM_Base_Start(&htim4);


函数名称全为大写，开头两个下划线，是HAL库中的宏定义，偏底层倾向于直接对寄存器操作

- 获取计数器的值
\_\_HAL_TIM_GET_COUNTER(&htim4);

- 设置计数器的值
\_\_HAL_TIM_SET_COUNTER(&htim4);

- 获取重装载计数器的值
\_\_HAL_TIM_GET_AUTORELOAD(&htim4);

- 设置重装载计数器的值
\_\_HAL_TIM_SET_AUTORELOAD(&htim4);

- 设置预分频器的值
\_\_HAL_TIM_SET_PRESCALER(&htim4);


补充知识点
预分频器有影子寄存器
\_\_HAL_TIM_SET_PRESCALER(&htim4);设置的寄存器是预分频器，工作在一线的是预分频器的影子寄存器，预分频器会等到计数器与重装载寄存器相同时 重新从0计数时，才会把新预分频设置给影子寄存器
设置的新预分频值，要等到下个周期才会生效

自动重装载寄存器也是一样有影子寄存器（不同是 可以根据需要选择是否开启影子寄存器机制）
自动重装载寄存器的影子功能选项
如果重装值比当前值小，则可能错过，等加到65535才会从0开始

![[Pasted image 20250404233234.png]]




总结流程
实现基本定时器的定时功能
1.勾选内部时钟源
2.根据APB1的定时器分支的速率 设置预分频器与自动重装载器的值
3.开启定时器中断
4.使用HAL_TIM_Base_Start_IT(&htim4);启动定时器
5.重写void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)

CubeMX中ETR2是什么意思
外部时钟模式2 涉及定时器的从模式